name: Deploy UPM Package

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Auto-detect package.json and deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Git identity
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Find package.json and extract version
        id: extract_version
        run: |
          # TÃ¬m táº¥t cáº£ package.json
          MATCH_FILE=$(find . -type f -name package.json -exec grep -l '"name": "com.undercats.boyou"' {} \;)
          
          if [ -z "$MATCH_FILE" ]; then
            echo "âŒ KhÃ´ng tÃ¬m tháº¥y package.json phÃ¹ há»£p!"
            exit 1
          fi

          VERSION=$(jq -r .version "$MATCH_FILE")
          echo "MATCH_FILE=$MATCH_FILE" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          echo "âœ… Found package.json at $MATCH_FILE"
          echo "ðŸ”¢ Version: $VERSION"

      - name: Deploy UPM package
        run: |
          set -ex

          SEMVER="$VERSION"
          if [ -z "$SEMVER" ]; then
            echo "You must provide the --semver option."
            exit 1
          fi

          # XÃ³a pháº§n /package.json Ä‘á»ƒ láº¥y thÆ° má»¥c gá»‘c
          PREFIX=$(dirname "$MATCH_FILE")
          BRANCH="upm"

          git subtree split --prefix="$PREFIX" --branch $BRANCH
          git tag $SEMVER $BRANCH
          git push origin $BRANCH --tags
          git push origin --delete $BRANCH
          git branch -D $BRANCH
